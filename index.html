<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Controle de Despesas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', Arial, sans-serif;
      margin: 15px;
      background: #f5f5f5;
      color: #333;
    }
    .app {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    h1, h2 { text-align: center; color: #333; margin: 10px 0; }
    h1 { font-size: 24px; }
    #status-sync {
      text-align: center;
      font-size: 13px;
      color: #777;
      margin: 10px 0;
    }
    form {
      margin-bottom: 20px;
      background: #f9f9f9;
      padding: 18px;
      border-radius: 10px;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .form-row > div {
      flex: 1 1 200px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      font-weight: 500;
      color: #555;
    }
    input, button, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
    }
    button[type="submit"] {
      background: #007bff;
      color: white;
      border: none;
      font-weight: 500;
    }
    button[type="submit"]:hover {
      background: #0056b3;
    }
    .filter-container {
      text-align: center;
      margin: 15px 0;
    }
    .filter-container input {
      width: auto;
      display: inline-block;
      font-size: 14px;
    }
    .filter-container button {
      font-size: 14px;
      padding: 8px 12px;
      background: #6c757d;
      color: white;
      border: none;
    }
    .resumo {
      text-align: center;
      margin: 15px 0;
      padding: 12px;
      background: #e7f3ff;
      border-radius: 8px;
      font-weight: 500;
      color: #004085;
      font-size: 15px;
    }
    #carregando {
      text-align: center;
      padding: 20px;
      color: #007bff;
      font-style: italic;
    }
    .despesa, .parcela {
      background: #fff;
      margin: 8px 0;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .despesa {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .despesa-actions {
      align-self: flex-end;
    }
    .parcela {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
    }
    .parcela.paga {
      text-decoration: line-through;
      color: green;
      background: #f0f8f0;
    }
    .total {
      font-weight: bold;
      color: #d9534f;
    }
    .excluir-btn {
      background: #d9534f !important;
      color: white;
      padding: 6px 10px;
      font-size: 13px;
    }
    .msg {
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      font-style: italic;
      font-size: 14px;
    }
    .msg.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .msg.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    .app-actions {
      text-align: center;
      margin: 20px 0;
    }
    .app-actions button {
      margin: 0 8px;
      padding: 10px 16px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    .btn-secondary:hover {
      background: #5a6268;
    }
    @media (max-width: 600px) {
      body { margin: 10px; }
      .app { padding: 15px; }
      h1 { font-size: 20px; }
      form { padding: 15px; }
      .form-row > div { flex: 1 1 100%; }
      .parcela {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }
      .parcela button {
        align-self: flex-start;
        margin-top: 4px;
      }
      .app-actions {
        flex-direction: column;
        gap: 10px;
      }
      .app-actions button {
        margin: 0;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Controle de Despesas</h1>
    <div id="status-sync">‚è≥ Carregando...</div>

    <form id="form">
      <div class="form-row">
        <div>
          <label for="desc">Descri√ß√£o</label>
          <input type="text" id="desc" placeholder="Ex: Assinatura" required />
        </div>
        <div>
          <label for="valorParcela">Valor (R$)</label>
          <input type="number" id="valorParcela" step="0.01" placeholder="50.00" required />
        </div>
      </div>
      <div class="form-row">
        <div>
          <label for="parcelas">Parcelas</label>
          <input type="number" id="parcelas" value="1" min="1" max="99" />
        </div>
        <div>
          <label for="data">1¬™ Parcela</label>
          <input type="date" id="data" required />
        </div>
      </div>
      <button type="submit">Adicionar Despesa</button>
    </form>

    <div class="filter-container">
      <label for="filtroMes">Filtrar por m√™s:</label>
      <input type="month" id="filtroMes" />
      <button onclick="limparFiltro()">Limpar</button>
    </div>

    <div id="carregando">Carregando suas despesas...</div>
    <div class="resumo" id="resumo">Carregando...</div>

    <h2>Despesas</h2>
    <div id="lista"></div>

    <div class="app-actions">
      <button onclick="exportarParaExcel()" class="btn-secondary">Exportar Excel</button>
      <button onclick="logout()" class="excluir-btn">Sair</button>
    </div>
  </div>

  <script type="module">
    if (!localStorage.getItem("userLoggedIn")) {
      window.location.href = "login.html";
    }

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      onSnapshot, 
      deleteDoc, 
      doc, 
      updateDoc 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBQMZg_PyiXZ0dRZK7q7ELdmnmXJZRKQu4",
      authDomain: "financia-1.firebaseapp.com",
      projectId: "financia-1",
      storageBucket: "financia-1.firebasestorage.app",
      messagingSenderId: "744474080905",
      appId: "1:744474080905:web:a72d939b44ea7878c0b858"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const despesasCollection = collection(db, "despesas");

    let despesas = [];
    let scriptCarregado = false;

    function salvarLocal(despesas) {
      try {
        const dados = {
          despesas,
          timestamp: Date.now(),
          userId: auth.currentUser?.uid
        };
        localStorage.setItem("despesasCache", JSON.stringify(dados));
      } catch (e) {
        console.warn("Erro ao salvar no localStorage", e);
      }
    }

    function carregarLocal() {
      try {
        const dados = localStorage.getItem("despesasCache");
        if (!dados) return null;
        const parsed = JSON.parse(dados);
        const userUid = auth.currentUser?.uid;
        if (!userUid || parsed.userId !== userUid) return null;
        const umaSemana = 7 * 24 * 60 * 60 * 1000;
        if (Date.now() - parsed.timestamp < umaSemana) {
          return parsed.despesas;
        }
        return null;
      } catch (e) {
        console.warn("Erro ao ler localStorage", e);
        return null;
      }
    }

    function setStatus(msg, cor = "#777") {
      const el = document.getElementById("status-sync");
      if (el) el.textContent = msg, el.style.color = cor;
    }

    function verificarVencidas() {
      const hoje = new Date();
      hoje.setHours(0, 0, 0, 0);

      const vencidas = despesas.flatMap(d => d.parcelas)
        .filter(p => !p.paid)
        .filter(p => new Date(p.date) < hoje);

      if (vencidas.length > 0) {
        const msg = document.createElement("div");
        msg.className = "msg warning";
        msg.textContent = `‚ö†Ô∏è Voc√™ tem ${vencidas.length} parcela(s) vencida(s)!`;
        const lista = document.getElementById("lista");
        lista.parentNode.insertBefore(msg, lista);
        setTimeout(() => msg.remove(), 5000);
      }
    }

    onAuthStateChanged(auth, (user) => {
      if (user && user.emailVerified) {
        const cache = carregarLocal();
        if (cache) {
          despesas = cache;
          render();
          atualizarResumo();
          verificarVencidas();
          document.getElementById("carregando").textContent = "üîÑ Sincronizando com a nuvem...";
          setStatus("üîÑ Usando cache local", "#f39c12");
        }

        onSnapshot(despesasCollection, (snapshot) => {
          const novasDespesas = [];
          snapshot.forEach(doc => {
            const data = doc.data();
            if (data.userId === user.uid) {
              novasDespesas.push({ id: doc.id, ...data });
            }
          });
          despesas = novasDespesas;
          salvarLocal(despesas);
          document.getElementById("carregando").style.display = "none";
          render();
          atualizarResumo();
          verificarVencidas();
          setStatus("‚úÖ Sincronizado com a nuvem", "#27ae60");
        }, (error) => {
          setStatus("‚ö†Ô∏è Offline (usando cache)", "#e67e22");
          if (cache) verificarVencidas();
        });
      } else {
        window.location.href = "login.html";
      }
    });

    function formatDate(date) {
      return new Date(date).toLocaleDateString("pt-BR");
    }

    function uid() {
      return "_" + Date.now() + "_" + Math.random().toString(36).substr(2, 6);
    }

    window.pagarParcela = async function (despesaId, parcelaId) {
      const d = despesas.find(x => x.id === despesaId);
      if (!d) return;
      const p = d.parcelas.find(x => x.id === parcelaId);
      if (p && !p.paid) {
        p.paid = true;
        try {
          await updateDoc(doc(db, "despesas", despesaId), { parcelas: d.parcelas });
        } catch (error) {
          alert("Erro ao atualizar: " + error.message);
        }
      }
    };

    window.excluirDespesa = async function (despesaId) {
      if (confirm("Excluir esta despesa?")) {
        try {
          await deleteDoc(doc(db, "despesas", despesaId));
        } catch (error) {
          alert("Erro ao excluir: " + error.message);
        }
      }
    };

    function atualizarResumo() {
      const total = despesas.flatMap(d => d.parcelas)
        .filter(p => !p.paid)
        .reduce((sum, p) => sum + parseFloat(p.value), 0);
      document.getElementById("resumo").innerHTML = `
        <strong>Total em aberto:</strong> R$ ${total.toFixed(2)}
      `;
    }

    function render() {
      const filtroMes = document.getElementById("filtroMes")?.value;
      const lista = document.getElementById("lista");
      if (!lista) return;
      lista.innerHTML = "";

      let despesasFiltradas = despesas;

      if (filtroMes) {
        const [ano, mes] = filtroMes.split("-").map(Number);
        despesasFiltradas = despesas.filter(d =>
          d.parcelas.some(p => {
            const data = new Date(p.date);
            return data.getFullYear() === ano && data.getMonth() === mes - 1;
          })
        );
      }

      despesasFiltradas.sort((a, b) => new Date(a.parcelas[0].date) - new Date(b.parcelas[0].date));

      if (despesasFiltradas.length === 0) {
        lista.innerHTML = "<p style='text-align: center; color: #777;'>Nenhuma despesa encontrada.</p>";
        return;
      }

      despesasFiltradas.forEach(d => {
        const div = document.createElement("div");
        div.className = "despesa";
        div.innerHTML = `
          <div>
            <strong>${d.desc}</strong><br>
            <small>${d.parcelas.length}x de R$ ${(d.total / d.parcelas.length).toFixed(2)}</small><br>
            <span class="total">Total: R$ ${d.total.toFixed(2)}</span>
          </div>
          <div class="despesa-actions">
            <button onclick="excluirDespesa('${d.id}')" class="excluir-btn">Excluir</button>
          </div>
        `;
        lista.appendChild(div);

        d.parcelas.forEach(p => {
          const pDiv = document.createElement("div");
          pDiv.className = "parcela" + (p.paid ? " paga" : "");
          pDiv.innerHTML = `
            <div>
              <span>${p.num}¬™ de ${p.total} - ${formatDate(p.date)}</span>
              <span>R$ ${parseFloat(p.value).toFixed(2)}</span>
            </div>
            <button onclick="pagarParcela('${d.id}','${p.id}')" ${p.paid ? 'disabled' : ''}>
              ${p.paid ? 'Pago' : 'Pagar'}
            </button>
          `;
          lista.appendChild(pDiv);
        });
      });

      atualizarResumo();
    }

    window.limparFiltro = () => {
      const el = document.getElementById("filtroMes");
      if (el) el.value = "";
      render();
    };

    window.exportarParaExcel = async function () {
      if (window.XLSX) return gerarPlanilha();
      if (scriptCarregado) return;
      const s = document.createElement("script");
      s.src = "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js";
      s.onload = () => { window.XLSX = XLSX; gerarPlanilha(); };
      s.onerror = () => alert("Erro ao carregar Excel.");
      document.head.appendChild(s);
      scriptCarregado = true;
    };

    function gerarPlanilha() {
      const wb = XLSX.utils.book_new();
      const data = [];
      despesas.forEach(d => d.parcelas.forEach(p => data.push({
        "Descri√ß√£o": d.desc,
        "Parcela": `${p.num}/${p.total}`,
        "Data": p.date,
        "Valor (R$)": p.value.toFixed(2),
        "Status": p.paid ? "Pago" : "Pendente"
      })));
      const ws = XLSX.utils.json_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, "Parcelas");
      XLSX.writeFile(wb, `despesas_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    document.getElementById("form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const desc = document.getElementById("desc").value.trim();
      const valorParcela = parseFloat(document.getElementById("valorParcela").value);
      const numParcelas = parseInt(document.getElementById("parcelas").value);
      const dataStr = document.getElementById("data").value;

      if (!desc) return alert("Descri√ß√£o √© obrigat√≥ria.");
      if (isNaN(valorParcela) || valorParcela <= 0) return alert("Valor inv√°lido.");
      if (!dataStr) return alert("Data √© obrigat√≥ria.");

      const [y, m, d] = dataStr.split("-").map(Number);
      const dataInicial = new Date(y, m - 1, d);
      if (dataInicial.getDate() !== d || dataInicial.getMonth() !== m - 1) {
        return alert("Data inicial inv√°lida.");
      }

      // ‚úÖ Gera√ß√£o correta das parcelas
      const parcelas = [];
      for (let i = 0; i < numParcelas; i++) {
        const mesAtual = m - 1 + i;
        const dataParcela = new Date(y, mesAtual, d);

        // ‚úÖ Ajusta para o √∫ltimo dia do m√™s se o dia n√£o existir
        if (dataParcela.getDate() !== d) {
          dataParcela.setMonth(mesAtual + 1, 0); // √∫ltimo dia
        }

        // ‚úÖ Formata manualmente (sem fuso hor√°rio)
        const dia = String(dataParcela.getDate()).padStart(2, '0');
        const mes = String(dataParcela.getMonth() + 1).padStart(2, '0');
        const ano = dataParcela.getFullYear();
        const dataFormatada = `${ano}-${mes}-${dia}`;

        parcelas.push({
          id: uid(),
          num: i + 1,
          total: numParcelas,
          value: valorParcela,
          date: dataFormatada,
          paid: false
        });
      }

      const currentUser = auth.currentUser;
      if (!currentUser) {
        alert("Erro: n√£o autenticado.");
        return;
      }

      try {
        await addDoc(despesasCollection, {
          desc,
          total: valorParcela * numParcelas,
          parcelas,
          userId: currentUser.uid
        });

        const msg = document.createElement("div");
        msg.className = "msg success";
        msg.textContent = `‚úÖ Despesa "${desc}" adicionada!`;
        document.querySelector("form").after(msg);
        setTimeout(() => msg.remove(), 3000);
        e.target.reset();
      } catch (error) {
        console.error("‚ùå Erro ao salvar:", error);
        alert("Erro ao salvar: " + error.message);
      }
    });

    window.logout = async () => {
      try {
        await signOut(auth);
        localStorage.removeItem("userLoggedIn");
        localStorage.removeItem("despesasCache");
        window.location.href = "login.html";
      } catch (error) {
        alert("Erro ao sair: " + error.message);
      }
    };
  </script>
</body>
</html>